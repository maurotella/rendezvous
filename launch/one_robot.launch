<launch>

    <arg name = "model" default="$(env TURTLEBOT3_MODEL)" doc="model type [burger, waffle, waffle_pi]"/>
    <arg name = "robot_name" default="" />
    <arg name = "pose_x"   default="0" />
    <arg name = "pose_y"   default="0" />
    <arg name = "pose_z"   default="0" />
    <arg name = "pose_yaw" default="0" />

    <!-- TurtleBot -->
    <param 
        name    = "robot_description" 
        command = "$(find xacro)/xacro --inorder $(find turtlebot3_description)/urdf/turtlebot3_$(arg model).urdf.xacro"
    />
    <node 
        name   = "robot_state_publisher" 
        pkg    = "robot_state_publisher" 
        type   = "robot_state_publisher" 
        output = "screen"
    >
        <param 
            name  = "publish_frequency" 
            type  = "double" 
            value = "50.0" 
        />
        <param 
            name  = "tf_prefix" 
            value = "$(arg robot_name)" 
        />
    </node>
    <node 
        name = "spawn_urdf" 
        pkg  = "gazebo_ros" 
        type = "spawn_model" 
        args = "-urdf -model $(arg robot_name) -param robot_description -x $(arg pose_x) -y $(arg pose_y) -z $(arg pose_z)" 
    />

    <!-- SLAM -->
    <include file = "$(find turtlebot3_slam)/launch/turtlebot3_gmapping.launch">
        <arg name = "set_base_frame" value="$(arg robot_name)/base_footprint"/>
        <arg name = "set_odom_frame" value="$(arg robot_name)/odom"/>
        <arg name = "set_map_frame"  value="$(arg robot_name)/map"/>
    </include>

    <!-- Map merging -->
    <group ns = "$(arg robot_name)/map_merge">
        <param name = "init_pose_x"   value="$(arg pose_x)"/>
        <param name = "init_pose_y"   value="$(arg pose_y)"/>
        <param name = "init_pose_z"   value="$(arg pose_z)"/>
        <param name = "init_pose_yaw" value="$(arg pose_yaw)"  />
    </group>
    <node 
        pkg     = "multirobot_map_merge" 
        type    = "map_merge" 
        respawn = "false" 
        name    = "map_merge" 
        output  = "screen"
    >
        <param name = "robot_map_topic" value="map"/>
        <param name = "robot_namespace" value="robot"/>
        <param name = "merged_map_topic" value="map"/>
        <param name = "world_frame" value="map"/>
        <param name = "known_init_poses" value="true"/>
        <param name = "merging_rate" value="0.5"/>
        <param name = "discovery_rate" value="0.05"/>
        <param name = "estimation_rate" value="0.1"/>
        <param name = "estimation_confidence" value="1.0"/>
    </node>
    <node 
        pkg="tf" 
        type="static_transform_publisher" 
        name="world_to_$(arg robot_name)_tf_broadcaster"  
        args="0 0 0 0 0 0 /map /$(arg robot_name)/map 100"
    />

    <!-- rviz 
    <group if="$(arg open_rviz)"> 
    <node pkg="rviz" type="rviz" name="rviz" required="true"
          args="-d $(find turtlebot3_slam)/rviz/turtlebot3_$(arg slam_methods).rviz"/>
    </group>
    <node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher"/>
    -->

</launch>